@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components.Authorization
@using GoldBusinessOne.Services
@implements IDisposable

<AuthorizeView>
    <Authorized>
        <div class="app-container">
            <!-- Mobile Topbar -->
            <div class="mobile-topbar d-lg-none">
                <div class="container-fluid">
                    <button class="btn-menu" @onclick="ToggleSidebar">
                        <i class="bi bi-list"></i>
                    </button>
                    <span class="brand">GoldBusiness ERP</span>
                    <div class="user-avatar">
                        <i class="bi bi-person-circle"></i>
                    </div>
                </div>
            </div>

            <div class="app-wrapper">
                <!-- Sidebar -->
                <div class="sidebar @(sidebarOpen ? "open" : "") @(isCollapsed ? "collapsed" : "")">
                    <div class="sidebar-header">
                        <div class="sidebar-brand">
                            <div class="brand-icon">
                                <i class="bi bi-gem"></i>
                            </div>
                            @if (!isCollapsed)
                            {
                                <div>
                                    <div class="brand-text">GoldBusiness</div>
                                    <div class="brand-subtext">Sistema ERP</div>
                                </div>
                            }
                        </div>
                        <button class="sidebar-toggle d-none d-lg-block" @onclick="ToggleCollapse">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                    </div>

                    <div class="sidebar-menu">
                        <NavMenu IsCollapsed="isCollapsed" />
                    </div>

                    <div class="sidebar-footer">
                        <div class="user-card">
                            <div class="user-avatar-large">
                                <i class="bi bi-person-circle"></i>
                            </div>
                            @if (!isCollapsed)
                            {
                                <div class="user-info">
                                    <div class="user-role">Administrador</div>
                                    <div class="user-name">@context.User.Identity?.Name</div>
                                    <div class="user-email">ERP System</div>
                                </div>
                            }
                        </div>
                        @if (!isCollapsed)
                        {
                            <button class="btn-logout w-100" @onclick="Logout">
                                <i class="bi bi-box-arrow-right me-2"></i>Cerrar sesión
                            </button>
                        }
                        else
                        {
                            <button class="btn-logout" @onclick="Logout" title="Cerrar sesión">
                                <i class="bi bi-box-arrow-right"></i>
                            </button>
                        }
                    </div>
                </div>

                <!-- Mobile Overlay -->
                @if (sidebarOpen)
                {
                    <div class="sidebar-overlay" @onclick="ToggleSidebar"></div>
                }

                <!-- Main Content -->
                <main class="main-content">
                    <!-- Desktop Topbar -->
                    <div class="desktop-topbar">
                        <div class="page-header">
                            <div>
                                <h1 class="page-title">Dashboard ERP</h1>
                                <p class="page-subtitle">
                                    Bienvenido, <strong>@context.User.Identity?.Name</strong> |
                                    Sistema de Gestión Integrada
                                </p>
                            </div>
                        </div>
                        <div class="header-actions">
                            <button class="btn-notifications">
                                <i class="bi bi-bell"></i>
                                <span class="notification-badge">3</span>
                            </button>
                            <button class="btn btn-outline-primary" @onclick="Logout">
                                <i class="bi bi-box-arrow-right me-1"></i>Cerrar sesión
                            </button>
                        </div>
                    </div>

                    <!-- Content Area -->
                    <div class="content-area animate-slide-in">
                        @Body
                    </div>
                </main>
            </div>
        </div>
    </Authorized>
    <NotAuthorized>
        <!-- Página de login/sin autenticar -->
        <div class="full-page">
            @Body
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    [Inject] private IAuthService AuthService { get; set; } = null!;
    [Inject] private NavigationManager Navigation { get; set; } = null!;

    private bool sidebarOpen = false;
    private bool isCollapsed = false;

    private async Task Logout()
    {
        await AuthService.LogoutAsync();
    }

    private void ToggleSidebar()
    {
        sidebarOpen = !sidebarOpen;
    }

    private void ToggleCollapse()
    {
        isCollapsed = !isCollapsed;
    }

    public void Dispose()
    {
        // Cleanup si es necesario
    }
}